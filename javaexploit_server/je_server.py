#! /usr/bin/python2.7
"""
'je_server.py' runs the server-side script for collecting CVE Data.
Access any Data from the intended output files:
"""

import logging
import urllib2
from bs4 import BeautifulSoup
import simplejson
from datetime import *
from time import time
from operator import itemgetter


# Logging configuration
logger = logging.getLogger('je_server.py')
logger.setLevel(logging.DEBUG)
ch = logging.FileHandler('je_server_log.log')
ch.setLevel(logging.DEBUG)
formatter = logging.Formatter('%(asctime)s - %(name)s - %(levelname)s - %(message)s')
ch.setFormatter(formatter)
logger.addHandler(ch)


def dataparser():
	datacollection = []
	html = urllib2.urlopen('http://cve.mitre.org/cgi-bin/cvekey.cgi?keyword=Java').read()
	soup = BeautifulSoup(html, 'html5lib')
	table = soup.find(id='TableWithRules')
	for td in table.find_all('tr'):
		try:
			name = td.find('a').text
			info = td.find_next('td').find_next('td').text
			info = ' '.join(info.encode('utf8').split())
			datacollection.append({
				"name": name.encode('utf8'),
				"info": info,
			})
		except AttributeError:
			pass
	cvetotal = soup.find('b').text

	f = open('/var/www/java-exploit.com/data/datacollection.json', 'w')
	f.write(simplejson.dumps(sorted(datacollection, key=itemgetter('name'), reverse=True)))
	f.close()

	return cvetotal


def currenttime():
	currentcvetotal = dataparser()
	nf = open('/var/www/java-exploit.com/data/last_scrape_date.json', 'r')
	datacollection = nf.read()
	old_shitty_data = simplejson.loads(datacollection)
	nf.close
	if old_shitty_data['cvetotal'] != currentcvetotal:
		nf = open('last_scrape_date.json', 'w')
		nf.write(simplejson.dumps({
			"cvetotal": currentcvetotal,
			"last_exploit_time": time(),
		}))
	nf.close

currenttime()
